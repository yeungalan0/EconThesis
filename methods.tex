Our original peer effects model is as follows:
\setlength{\belowdisplayskip}{6pt} \setlength{\belowdisplayshortskip}{1pt}
\setlength{\abovedisplayskip}{-4pt} \setlength{\abovedisplayshortskip}{1pt}

\begin{equation}\label{eq:0}
G_{i} = \beta_{0} + \beta_{1} Ability_{i} + \beta_{2} Ability_{i}^{CM1} + \beta_{3} Ability_{i}^{CM2} + \overrightarrow{\beta} \overrightarrow{z} + \epsilon_{i}
\end{equation}

Where $\epsilon_{i} \stackrel{iid}{\sim} N(0,\sigma_{\epsilon}^2)$, $G_{i}$ is the grade received by student $i$ in their first course at the institution, $Ability_{i}$ is a proxy for the student's academic ability (Academic Rating)\footnote{For more information see \tablelabel{tab:def1}.}, $Ability_{i}^{CM1}$ and $Ability_{i}^{CM2}$ are classmate ability measures, and $\overrightarrow{z}$ is a vector of control variables.\footnote{Control variables included Minority, Female, InState, International, Needy, Class Size, URM, Year, Division, and Professor. See \tablelabel{tab:def1} and \tablelabel{tab:def2} for definitions.}
$Ability_{i}^{CM1}$ and $Ability_{i}^{CM2}$ are our peer measures and are defined as one of the following, the proportion of high achieving, middle achieving, or low achieving students in a class\footnote{Unfortunately due to data limitations only the proportion of high achievers and low achievers in a class is used for our peer measures, for more details see \sectlabel{results}.}(as defined by cutoffs in academic rating), and $Ability_{i}^{CM1}$ is not the same measure as  $Ability_{i}^{CM2}$. 
Thus $\beta_{2}$ and $\beta_{3}$ are the primary coefficients of interest, as they estimate the impact of the classmates ability variables (our peer measures) on a student's grade. 
The model \eqref{eq:0} is regressed on the subset of students that are not incorporated in the peer measures. 
For example, if $Ability_{i}^{CM1}$ and $Ability_{i}^{CM2}$ are defined as the proportion of high achievers in a class and the proportion of low achievers in a class respectively, then the model would be regressed on the middle achievers. 

However, since our sample is nonrandom\footnote{Unfortunately students are not assigned to classes and institutions randomly, instead the institution selects specific students, students next select the institution, and students then select into classes.} the calculated coefficients of model \eqref{eq:0} are at risk of being bias \citep{heckman1979sample}.  
This bias, known as selection bias, is a serious threat to peer effects models of this type because students (or in some cases parents) often get a choice in selecting an institution to attend \citep{carman2012classroom,burke2013classroom,ding2007peers}. 
This selection, as discussed by \citet{kang2007classroom}, often leads to a non-random sample because students of similar personal and family backgrounds often select into the same institutions.
We are concerned about a similar self-selection, but at the classroom level, that is, students of similar personal and family backgrounds may select into similar classes, creating a non-random sample in each classroom and biasing our results.
Therefore, we must update our model to correct for any selection bias that may exist.

\subsection{Two Stage Selection Model}\label{methods:tssmodel}

We control for two types of selection bias. 
The first type of selection bias is due to selection into courses based on previous relationships. 
Some students may be selecting into courses because they have intelligent friends in those courses who may be willing to help them.
In this case, the coefficients would be bias because an unobservable factor (previous relationships) is correlated with both the course grade and classmate ability levels (our peer measure). 
We control for this by limiting our data to first year students in their first course at the institution.
The incoming classes at the institution come from a diverse background, both geographically and socioeconomically, so it is highly unlikely that students are selecting their first course based on any prior relationship to classmates.
This effectively eliminates the first type of selection bias, self-selecting into courses based on prior bonds/relationships.

The second type of selection bias we control for is students selecting into courses where they are likely to perform well (or poorly), due to unobservable factors. 
For instance, some students may intentionally select into courses where they are likely to receive a high grade, due to unobservable factors (interest in the course, previous experience in the subject, etc.), that happen to also attract students of a certain ability level.
In this case, the coefficients would be bias because unobservable factors are correlated with both the course grade and classmate ability levels (our peer measure).
We control for this type of selection bias by using a two stage selection model.
Specifically, our model is controlling for any selection bias that results from students selecting into courses that are high or low on their preference list.\footnote{The cutoffs that define a ``high'' and ``low'' preference course are determined by the number of categories ($j$) in our selection model.} 
The idea is that students that have unobservable characteristics that would lead them to do well in certain courses will have higher preferences for those courses, whereas students who have unobservable characteristics that would lead them to do less well in a course (lack of interest, disappointment about not getting into a high preference course, etc.) will have low preferences for the course.
By controlling for student course preferences we are controlling for some of the unobservable factors that, as a result of student self-selection into courses, may bias our coefficients.

As discussed in \sectlabel{litreview}, most studies of this kind exploit quasi-random student class assignments or utilize fixed effects models to control for selection bias \citep{kang2007classroom,carman2012classroom,schlosser2008inside,lavy2012good}. 
However, due to our unique access to student preference data, we use a two stage selection model to correct for selection bias, similar to the one described in \citet{heckman1979sample}. 
Our two stage selection model uses an ordered probit model in the first stage (the selection equation) and OLS in the second stage (the outcome equation). 
From the first stage ordered probit model we take the calculated inverse mills ratios and use them as a control variable in the second stage outcome equation. 
The inverse mills ratios are calculated estimates, that when used in the outcome equation, help to control for selection bias \citep{heckman1979sample}.\footnote{For more information see \citet{greene2002limdep}.}

For the selection equation we use an ordered probit model, defined as follows:

\setlength{\belowdisplayskip}{5pt} \setlength{\belowdisplayshortskip}{1pt}
\setlength{\abovedisplayskip}{-6pt} \setlength{\abovedisplayshortskip}{1pt}

\begin{equation}\label{eq:1}
R_{i}^{*} = \alpha_{1} D_{i} + \overrightarrow{\alpha} \overrightarrow{\omega} + \epsilon_{i}
\end{equation}

\setlength{\belowdisplayskip}{11pt} \setlength{\belowdisplayshortskip}{1pt}
\setlength{\abovedisplayskip}{-4pt} \setlength{\abovedisplayshortskip}{1pt}

\begin{equation}\label{eq:2}
R_{i} = 
\begin{cases}
  1 \ \ if \ \ - \infty < R_{i}^{*} \leq \mu_{1} \\
  \vdots \\
  j \ \ if \ \ \mu_{j} < R_{i}^{*} < \infty
\end{cases}
\end{equation}

Where $D_{i}$ is the demand for the student's selected course, $\overrightarrow{\omega}$ is a vector of control variables\footnote{Specifically the variables include Minority, Female, InState, Intl, Needy, AcadRating, URM (Underrepresented Minority), and Subject. See \tablelabel{tab:def1} and \tablelabel{tab:def2} for definitions.}, and $\epsilon_{i}$ is the error term. 
In \eqref{eq:2} we see that the unobserved selection variable $R_{i}^{*}$ corresponds to the observed $R_{i}$ through $\mu$, a vector of unknown cutoffs. 
The variable $j$ represents the number of selection categories, where in any of our regressions $j$ is at least two and at most four. 
For example, if $j$ is equal to two, then $R_{i}$ equal to one represents those students who selected into their first choice course and $R_{i}$ equal to two represents those students who did not select into their first choice course (instead selecting into their second choice, third choice, etc.). 
The ordered probit model estimates the probability that $R_{i}$ is equal to $j$ using $R_{i}^{*}$, that is, 

\setlength{\belowdisplayskip}{5pt} \setlength{\belowdisplayshortskip}{1pt}
\setlength{\abovedisplayskip}{-4pt} \setlength{\abovedisplayshortskip}{1pt}

\begin{equation}\label{eq:3}
Pr(R_{i} = j) \ = \ Pr(\mu_{j-1} < R_{i}^{*} \leq \mu_{j})
\end{equation}

\noindent Once we estimate the selection equation, we include the inverse mills ratios in the outcome equation.

We use a model very similar to our original model \eqref{eq:0} as our outcome equation. 
The only difference is that the inverse mills ratios ($\lambda$) are added as a control variable to correct for selection bias. 
The model is as follows:

\begin{equation}\label{eq:4}
G_{i} = \beta_{0} + \beta_{1} Ability_{i} + \beta_{2} Ability_{i}^{CM1} + \beta_{3} Ability_{i}^{CM2} + \beta_{4} \lambda_{i} + \overrightarrow{\beta} \overrightarrow{z} + \epsilon_{i}
\end{equation}

Where the variables are defined in the same manner as \eqref{eq:0}, and $\lambda_{i}$ is the inverse mills ratios taken from the first stage regression.
Just as in \eqref{eq:0} the model \eqref{eq:4} is regressed on the subset of students that are not part of the peer measures. 
However, the calculation of different inverse mills ratios for each of the possible selection categories makes it necessary for a separate regression to be estimated on each of the students who selected into a particular selection category.\footnote{This is why there are Grade1, Grade2, etc. categories in the regressions seen in \sectlabel{results}.}
As an example, suppose $Ability_{i}^{CM1}$ and $Ability_{i}^{CM2}$ are defined as the proportion of high achievers in a course and the proportion of low achievers in a course respectively and the number of selection categories ($j$) is equal to two. 
The outcome equation \eqref{eq:4} will first be regressed on the middle achievers who selected into their first choice course, then on the middle achievers who did not select into their first choice course, producing two sets of regression outputs. 